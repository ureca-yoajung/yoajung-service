<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>메인 페이지 - YOAJUNG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/main.css"/>
</head>
<body>
<div id="navbar"></div>
<main class="main-content">
    <section class="main-hero">
        <div class="main-hero-title">나에게 꼭 맞는 <span class="highlight">요금제</span>를 추천받으세요!</div>
        <div class="main-hero-desc">데이터, 통화, 가격까지 맞춤형 컨설팅</div>
        <div class="main-actions">
            <button onclick="showTendencyModal()" class="btn btn-primary">성향 등록/수정</button>
            <a href="plan-list.html" class="btn btn-ghost">요금제 전체보기</a>
        </div>
    </section>
    <section class="main-cards">
        <div class="card">
            <div class="card-title">내 성향</div>
            <div class="card-content" id="tendency-summary">
                아직 입력된 성향 정보가 없습니다.<br> [성향 등록/수정] 버튼을 눌러보세요!
            </div>
        </div>
        <div class="card">
            <div class="card-title">내 정보</div>
            <div class="card-content">
                <a href="mypage.html" class="btn btn-primary">마이페이지 바로가기</a>
            </div>
        </div>
    </section>
</main>

<!-- 성향 입력 모달 -->
<div id="modal-bg"></div>
<div id="tendency-modal">
    <h3>성향 정보 입력</h3>
    <form id="tendency-form">
        <label>월평균 데이터 사용량(GB)
            <input name="avgMonthlyDataGB" type="number" required>
        </label>
        <label>월평균 통화량(분)
            <input name="avgMonthlyVoiceMin" type="number" required>
        </label>
        <label>희망 요금제 가격(원)
            <input name="preferencePrice" type="number" required>
        </label>
        <label>기타(주요 사용 목적 등)
            <input name="comment" required>
        </label>
        <button type="submit">등록</button>
        <button type="button" id="tendency-later">다음에 하기</button>
    </form>
</div>

<script>
    // 네비게이션 및 로그인/로그아웃 상태 렌더링
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/assets/navbar.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('navbar').innerHTML = html;
                renderNavButtons();
            });

        // 내 성향 요약 표시
        fetch('/api/tendency/me', {credentials: 'include'})
            .then(res => {
                if (res.status === 401) {
                    // 로그인 안된 경우 버튼 비활성화
                    document.querySelector('.btn.btn-primary').disabled = true;
                    // showTendencyModal도 비활성화
                    window.showTendencyModal = () => {
                    }; // 빈 함수로 덮어씌움
                    return null;
                }
                return res.json();
            })
            .then(data => {
                const el = document.getElementById('tendency-summary');
                if (data && data.data) {
                    el.innerHTML = `
                        <b>데이터:</b> ${data.data.avgMonthlyDataGB}GB<br>
                        <b>통화:</b> ${data.data.avgMonthlyVoiceMin}분<br>
                        <b>희망가격:</b> ${data.data.preferencePrice}원<br>
                        <b>비고:</b> ${data.data.comment || '-'}
                    `;
                }
            });
    });

    async function renderNavButtons() {
        const navBtns = document.getElementById('nav-auth-buttons');
        if (!navBtns) return;
        try {
            const res = await fetch('/api/user/me', {credentials: 'include'});
            if (res.ok) {
                navBtns.innerHTML = `
                    <a href="mypage.html" class="btn btn-ghost">마이페이지</a>
                    <button id="logout-btn" class="btn btn-primary">로그아웃</button>
                `;
                document.getElementById('logout-btn').onclick = async function () {
                    await fetch('/api/auth/logout', {method: 'POST', credentials: 'include'});
                    location.href = "login.html";
                };
            } else {
                navBtns.innerHTML = `
                    <a href="login.html" class="btn btn-ghost">로그인</a>
                    <a href="signup.html" class="btn btn-primary">시작하기</a>
                `;
            }
        } catch {
            navBtns.innerHTML = `
                <a href="login.html" class="btn btn-ghost">로그인</a>
                <a href="signup.html" class="btn btn-primary">시작하기</a>
            `;
        }
    }

    // 모달 표시/숨김
    function showTendencyModal() {
        fetch('/api/user/me', {credentials: 'include'}).then(res => {
            if (res.status === 401) {
                alert("로그인이 필요합니다.");
                window.location.href = "login.html";
                return;
            }
            document.getElementById('modal-bg').style.display = "block";
            document.getElementById('tendency-modal').style.display = "block";
        });
    }

    function hideTendencyModal() {
        document.getElementById('modal-bg').style.display = "none";
        document.getElementById('tendency-modal').style.display = "none";
    }

    document.getElementById('modal-bg').onclick = hideTendencyModal;

    // 성향 등록
    document.getElementById('tendency-form').onsubmit = function (e) {
        e.preventDefault();
        const obj = Object.fromEntries(new FormData(e.target));
        fetch('/api/tendency', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(obj)
        }).then(res => res.json())
            .then(data => {
                alert(data.message || "등록 완료");
                hideTendencyModal();
                location.reload();
            });
    };
    document.getElementById('tendency-later').onclick = hideTendencyModal;

    // 진입 시 성향 등록여부 확인
    window.onload = function () {
        fetch('/api/tendency/me', {credentials: 'include'})
            .then(res => res.json())
            .then(data => {
                if (!data.data) showTendencyModal();
            });
    }
</script>
</body>
</html>