<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5G ìŠ¤íƒ ë‹¤ë“œ - YOAJUNG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/884094d6e6.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="assets/css/plan-detail.css"/>
    <link rel="stylesheet" href="assets/css/plan-detail-review.css"/>
</head>

    <body>
        <!-- Navigation -->
        <div id="navbar"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="index.html">í™ˆ</a> >
                <a href="plans.html">ìš”ê¸ˆì œ</a> >
                <div id="planDetailName"> 5G ìŠ¤íƒ ë‹¤ë“œ </div>
            </div>

            <div class="plan-header">
                <div class="plan-info">
                    <h1 id="planName">ë¡œë”© ì¤‘...</h1>
                    <div class="plan-badges">
                        <span class="badge badge-5g" id="planCategory">5G</span>
                        <span class="badge badge-category" id="planTarget">PHONE</span>
                    </div>
                    <div class="plan-price">
                        ì›” <span id="basePrice">0</span>ì›
                    </div>
                    <p class="plan-description" id="planDescription">
                        ë¡œë”© ì¤‘...
                    </p>

                    <div class="plan-features">
                        <div class="feature-item" id="dataIcon">
                            <div class="feature-icon">ğŸ“±</div>
                            <span class="feature-text">ë°ì´í„° <span id="dataAllowance">0</span></span>
                        </div>
                        <div class="feature-item" id="tetheringIcon">
                            <div class="feature-icon">ğŸ”—</div>
                            <span class="feature-text">í…Œë”ë§ <span id="tetheringSharingAllowance">0</span></span>
                        </div>
                        <div class="feature-item" id="speedIcon">
                            <div class="feature-icon">ğŸš€</div>
                            <span class="feature-text"><span id="speedAfterLimit">0</span></span>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Benefits Section -->
            <div class="benefits-section" id="baseBenefitsContainer">
                <div class="benefit-category">
                    <div class="category-header">
                        <h1 class="category-title">
                            <span class="category-icon">â­</span>
                            ê¸°ë³¸ í˜œíƒ
                        </h1>
                        <p class="category-description">ê¸°ë³¸ìœ¼ë¡œ ì œê³µë˜ëŠ” í˜œíƒì…ë‹ˆë‹¤</p>
                    </div>
                </div>
                <div class="benefits-container" id="baseBenefitsSection">
                    <div class="benefits-grid" id="baseBenefits"></div>
                </div>
            </div>

            <!-- Media Benefits -->
            <div class="benefits-section" id="mediaContainer">
                <!-- Media Benefits -->
                <div class="benefit-category">
                    <div class="category-header">
                        <h1 class="category-title">
                            <span class="category-icon">ğŸµ</span>
                            ë¯¸ë””ì–´ í˜œíƒ
                            <span class="choose-one-badge">íƒ 1</span>
                        </h1>
                        <p class="category-description">ë‹¤ì–‘í•œ ë¯¸ë””ì–´ ì„œë¹„ìŠ¤ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                    </div>
                </div>
                <div class="products-container" id="mediaBenefitsSection">
                    <button class="scroll-button prev" onclick="scrollMedia('mediaBenefits', -1)">
                        <i class="fa-solid fa-angle-left" style="color: black"></i>
                    </button>
                    <div class="products-grid" id="mediaBenefits"></div>
                    <button class="scroll-button next" onclick="scrollMedia('mediaBenefits', 1)">
                        <i class="fa-solid fa-angle-right" style="color: black"></i>
                    </button>
                </div>
            </div>

            <!-- Benefits Section -->
            <div class="benefits-section" id="premiumContainer">
                <!-- Premium Benefits -->
                <div class="benefit-category">
                    <div class="category-header">
                        <h1 class="category-title">
                            <span class="category-icon">ğŸ</span>
                            í”„ë¦¬ë¯¸ì—„ í˜œíƒ
                            <span class="choose-one-badge">íƒ 1</span>
                        </h1>
                        <p class="category-description">í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                    </div>
                </div>
                <div class="products-container" id="premiumBenefitsSection">
                    <button class="scroll-button prev" onclick="scrollPremium('premiumBenefits', -1)">
                        <i class="fa-solid fa-angle-left" style="color: black"></i>
                    </button>
                    <div class="products-grid" id="premiumBenefits"></div>
                    <button class="scroll-button next" onclick="scrollPremium('premiumBenefits', 1)">
                        <i class="fa-solid fa-angle-right" style="color: black"></i>
                    </button>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="reviews-section">
                <div class="reviews-header">
                    <h2 class="reviews-title">ì‚¬ìš©ì ë¦¬ë·°</h2>
                    <div class="reviews-stats">
                        <div class="rating-summary">
                            <span class="rating-score" id="averageRating">0.0</span>
                            <div class="stars" id="averageStars"></div>
                            <span class="review-count" id="reviewCount">(0ê°œ ë¦¬ë·°)</span>
                        </div>
                        <button id="write-review-btn" class="write-review-btn" onclick="toggleReviewForm()"  style="display: none;">
                            ë¦¬ë·° ì‘ì„±
                        </button>
                    </div>
                </div>

                <!-- Review Form -->
                <div class="review-form" id="reviewForm">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">ë¦¬ë·° ì‘ì„±</h3>
                    <form onsubmit="submitReview(event)">
                        <div class="form-group">
                            <label class="form-label">í‰ì </label>
                            <div class="rating-input" id="ratingInput">
                                <span class="rating-star" data-rating="1">â˜…</span>
                                <span class="rating-star" data-rating="2">â˜…</span>
                                <span class="rating-star" data-rating="3">â˜…</span>
                                <span class="rating-star" data-rating="4">â˜…</span>
                                <span class="rating-star" data-rating="5">â˜…</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="reviewContent" class="form-label">ë‚´ìš©</label>
                            <textarea id="reviewContent" class="form-textarea" placeholder="ì´ ìš”ê¸ˆì œì— ëŒ€í•œ ê²½í—˜ì„ ê³µìœ í•´ì£¼ì„¸ìš”" required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancel" onclick="toggleReviewForm()">ì·¨ì†Œ</button>
                            <button type="submit" class="btn-submit">ë¦¬ë·° ë“±ë¡</button>
                        </div>
                    </form>
                </div>

                <!-- Reviews List -->
                <div class="reviews-list" id="reviewsList">
                    <!-- Reviews will be loaded here -->
                </div>

                <div class="pagination" id="reviewsPagination" style="text-align: center; margin-top: 20px;"></div>
            </div>
        </main>

        <button class="chat-button" onclick="startRecommendation()" title="AI ì¶”ì²œ ë°›ê¸°">ğŸ’¬</button>

        <button id="scrollTopBtn" title="ë§¨ ìœ„ë¡œ"><i class="fa-solid fa-caret-up" style="color: white"></i></button>


        <script>
            // Global variables
            let selectedRating = 0;
            let planData = null;
            let benefitsData = null;
            let productsData = null;
            let reviewsData = [];
            let responseReview = [];
            let planId;

            let currentPage = 0;
            const pageSize = 5;
            let totalPages = 1;

            let editingReviewId = null;
            let originalData = {};

            // Initialize page
            document.addEventListener('DOMContentLoaded', async () => {
                await loadNavbar();
                planId = getPlanIdFromUrl() || 1;

                await Promise.all([
                    loadPlanData(planId),
                    loadBenefitsData(planId),
                    loadProductsData(planId),
                    loadReviewsData(planId)
                ]);

                initializeRatingSystem();
            });

            // Common API request handler
            async function apiRequest(url, options = {}) {
                try {
                    const response = await fetch(url, options);

                    if (response.status === 401) {
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        window.location.href = "/login";
                        return null;
                    }

                    if (!response.ok) {
                        const result = await response.json().catch(() => ({}));
                        throw new Error(result.message || `HTTP ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`API ìš”ì²­ ì‹¤íŒ¨ (${url}):`, error);
                    throw error;
                }
            }

            // Load navbar
            async function loadNavbar() {
                try {
                    const response = await fetch('/assets/navbar.html');
                    if (response.ok) {
                        const html = await response.text();
                        document.getElementById('navbar').innerHTML = html;
                    }
                } catch (err) {
                    console.error('navbar ë¡œë”© ì‹¤íŒ¨:', err);
                }
            }

            // Extract plan ID from URL
            function getPlanIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id') || window.location.pathname.split('/').pop();
            }

            // Data loading functions
            async function loadPlanData(planId) {
                try {
                    const result = await apiRequest(`/api/plan/${planId}`);
                    if (result && result.status === 'OK' && result.data) {
                        planData = result.data;
                    }
                } catch (error) {
                    console.error('Plan data loading failed:', error);
                } finally {
                    updatePlanInfo();
                }
            }

            async function loadBenefitsData(planId) {
                try {
                    const result = await apiRequest(`/api/plan/benefits/${planId}`);
                    if (result && result.status === 'OK' && result.data) {
                        benefitsData = result.data;
                    }
                } catch (error) {
                    console.error('Benefits data loading failed:', error);
                } finally {
                    updateBenefitsInfo();
                }
            }

            async function loadProductsData(planId) {
                try {
                    const result = await apiRequest(`/api/plan/products/${planId}`);
                    if (result && result.status === 'OK' && result.data) {
                        productsData = result.data;
                    }
                } catch (error) {
                    console.error('Products data loading failed:', error);
                } finally {
                    updateProductsInfo();
                }
            }

            async function loadReviewsData(planId) {
                try {
                    const result = await apiRequest(`/review/${planId}?page=${currentPage}&size=${pageSize}`);
                    if (result && result.status === 'OK' && result.data) {
                        responseReview = result.data;
                        totalPages = result.data.totalPages;

                        const reviewWriteBtn = document.getElementById('write-review-btn');
                        if (reviewWriteBtn) {
                            reviewWriteBtn.style.display = result.data.isPlanUser ? 'inline-block' : 'none';
                        }
                    }
                } catch (error) {
                    console.error('Reviews data loading failed:', error);
                } finally {
                    updateReviewsInfo();
                }
            }

            function updatePlanInfo() {
                if (!planData) return;

                const get = (id) => document.getElementById(id);

                const dataAllowance = planData.dataAllowance;
                const tethering = planData.tetheringSharingAllowance;
                const speed = planData.speedAfterLimit;

                const setFeatureVisibility = (value, textId, wrapperId, formatter) => {
                    const textEl = get(textId);
                    const wrapperEl = get(wrapperId);
                    if (!textEl || !wrapperEl) return;

                    if (value === 0) {
                        wrapperEl.style.display = 'none';
                    } else {
                        textEl.textContent = formatter(value);
                        wrapperEl.style.display = 'flex';
                    }
                };

                setFeatureVisibility(
                    dataAllowance,
                    'dataAllowance',
                    'dataIcon',
                    (val) => val === 9999 ? 'ë¬´ì œí•œ' : `${val}GB`
                );

                setFeatureVisibility(
                    tethering,
                    'tetheringSharingAllowance',
                    'tetheringIcon',
                    (val) => val === 9999 ? 'ë¬´ì œí•œ' : `${val}GB`
                );

                setFeatureVisibility(
                    speed,
                    'speedAfterLimit',
                    'speedIcon',
                    (val) => val === 9999 ? 'ì†ë„ì œí•œ ì—†ìŒ' : `ë‹¤ ì“°ë©´ ìµœëŒ€ +${val}Mbps`
                );

                const categoryMap = {
                    ALL: 'ì „ì²´',
                    LTE_FIVE_G: 'LTE/5G',
                    ONLINE_ONLY: 'ì˜¨ë¼ì¸ ì „ìš©'
                };

                const updates = {
                    planName: planData.name,
                    planDetailName: planData.name,
                    basePrice: planData.basePrice.toLocaleString(),
                    planDescription: planData.description,
                    planCategory: categoryMap[planData.planCategory] || planData.planCategory,
                    planTarget: planData.planTarget
                };

                Object.entries(updates).forEach(([id, value]) => {
                    const element = get(id);
                    if (element) element.textContent = value;
                });
            }


            function updateBenefitsInfo() {
                if (!benefitsData) return;

                const container = document.getElementById('baseBenefitsContainer');
                const grid = document.getElementById('baseBenefits');

                grid.innerHTML = '';

                const categoryTypes = {
                    voice: 'VOICE',
                    sms: 'SMS',
                    smartDevice: 'SMARTDEVICE',
                    base: 'BASE',
                    other: 'OTHER'
                };

                let hasBenefits = false;

                for (const [key, type] of Object.entries(categoryTypes)) {
                    const benefit = benefitsData[key];
                    if (benefit) {
                        const benefitCard = createBenefitCard({
                            id: `${type.toLowerCase()}_benefit`,
                            name: benefit.name,
                            description: benefit.description,
                            type: type,
                            discountAmount: benefit.discountAmount
                        });
                        grid.appendChild(benefitCard);
                        hasBenefits = true;
                    }
                }

                // í‘œì‹œ ì—¬ë¶€ ê²°ì •
                container.style.display = hasBenefits ? 'flex' : 'none';
            }

            function updateProductsInfo() {
                const containers = {
                    premium: document.getElementById('premiumContainer'),
                    media: document.getElementById('mediaContainer')
                };

                const sections = {
                    premium: document.getElementById('premiumBenefitsSection'),
                    media: document.getElementById('mediaBenefitsSection')
                };

                const grids = {
                    premium: document.getElementById('premiumBenefits'),
                    media: document.getElementById('mediaBenefits')
                };

                // ì´ˆê¸°í™”
                Object.values(grids).forEach(grid => grid.innerHTML = '');
                Object.values(sections).forEach(section => section.classList.remove('has-benefits'));
                Object.values(containers).forEach(container => container.style.display = 'none');

                if (!productsData) return;

                ['media', 'premium'].forEach(type => {
                    if (productsData[type] && productsData[type].length > 0) {
                        containers[type].style.display = 'flex'; // ë˜ëŠ” 'block' ë“± ë ˆì´ì•„ì›ƒì— ë§ê²Œ
                        sections[type].classList.add('has-benefits');

                        productsData[type].forEach((product, index) => {
                            const productCard = createProductCard({
                                id: `${type}_${index}`,
                                name: product.name,
                                description: product.description,
                                type: type.toUpperCase(),
                                imageUrl: product.productImage
                            });
                            grids[type].appendChild(productCard);
                        });
                    }
                });
            }

            function updateReviewsInfo() {
                if (!responseReview.content) return;

                reviewsData = responseReview.content.map(review => ({
                    id: review.reviewId,
                    userId: review.userId,
                    userName: review.userName,
                    content: review.content,
                    rating: review.star,
                    helpful: review.likeCnt,
                    notHelpful: 0,
                    createdAt: review.createDate,
                    isAuthor: review.author,
                    isLiked: review.liked
                }));

                updateReviewsStats();
                renderReviews();
                renderPagination();
            }

            function updateReviewsStats() {
                const avgRating = parseFloat(responseReview.avgStar || 0);
                const totalElements = responseReview.totalElements || 0;

                document.getElementById('averageRating').textContent = avgRating.toFixed(1);
                document.getElementById('reviewCount').textContent = `(${totalElements}ê°œ ë¦¬ë·°)`;

                const starsContainer = document.getElementById('averageStars');
                starsContainer.innerHTML = '';
                const rating = Math.round(avgRating);

                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = i <= rating ? 'star' : 'star empty';
                    star.textContent = 'â˜…';
                    starsContainer.appendChild(star);
                }
            }

            // Card creation functions
            function createBenefitCard(benefit) {
                const card = document.createElement('div');
                card.className = 'benefit-card';
                card.setAttribute('data-benefit-id', benefit.id);

                const limitText = (benefit.discountAmount && benefit.discountAmount > 0)
                    ? `${benefit.discountAmount.toLocaleString()}ì› í• ì¸`
                    : 'ì œê³µ';

                card.innerHTML = `
                    <div class="benefit-header">
                        <div class="benefit-info">
                            <h4 class="benefit-name">${benefit.name}</h4>
                        </div>
                    </div>
                    <p class="benefit-description">${benefit.description}</p>
                    <div class="benefit-details">
                        <span class="benefit-limit">${limitText}</span>
                    </div>
                `;

                return card;
            }

            function createProductCard(product) {
                const card = document.createElement('div');
                card.className = 'product-card';

                // ì´ë¯¸ì§€ íŒŒì‹± ë¡œì§
                let imgText = '';
                if (product.imageUrl) {
                    if (typeof product.imageUrl === 'object') {
                        imgText = product.imageUrl.data ?? '';
                    } else {
                        try {
                            const parsed = JSON.parse(product.imageUrl);
                            imgText = parsed.data ?? '';
                        } catch {
                            imgText = product.imageUrl;
                        }
                    }
                }

                // ì´ë¯¸ì§€ ìœ íš¨ì„± ì²´í¬ ë° ê¸°ë³¸ ì´ë¯¸ì§€ ì²˜ë¦¬
                const invalidValues = ['/', '', null, undefined];
                const isValidUrl =
                    typeof imgText === 'string' &&
                    !invalidValues.includes(imgText.trim()) &&
                    imgText.trim().length > 0;

                const finalImageUrl = isValidUrl ? imgText : '/assets/image/defaultImg.jpg';

                card.innerHTML = `
                    <img src="${finalImageUrl}" alt="${product.name}" class="product-image">
                    <div class="product-name">${product.name}</div>
                    <div class="product-description">${product.description}</div>
                `;

                return card;
            }

            // Review rendering functions
            function renderReviews() {
                const reviewsList = document.getElementById('reviewsList');
                reviewsList.innerHTML = '';

                if (reviewsData.length === 0) {
                    reviewsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px 0;">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>';
                    return;
                }

                reviewsData.forEach(review => {
                    const reviewElement = createReviewElement(review);
                    reviewsList.appendChild(reviewElement);
                });
            }

            function renderPagination() {
                const pagination = document.getElementById('reviewsPagination');
                pagination.innerHTML = '';

                if (totalPages <= 1) return;

                for (let i = 0; i < totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i + 1;
                    btn.className = (i === currentPage) ? 'active' : '';
                    btn.addEventListener('click', () => {
                        if (i !== currentPage) {
                            currentPage = i;
                            loadReviewsData(planId);
                        }
                    });
                    pagination.appendChild(btn);
                }
            }

            function createReviewElement(review) {
                const reviewDiv = document.createElement('div');
                reviewDiv.className = 'review-item';
                reviewDiv.setAttribute('data-review-id', review.id);

                const avatar = review.userName ? review.userName.charAt(0) : '?';
                const formattedDate = formatDate(review.createdAt);

                reviewDiv.innerHTML = `
        <div class="review-header">
            <div class="reviewer-info">
                <div class="reviewer-avatar">${avatar}</div>
                <div class="reviewer-details">
                    <h4>${review.userName || 'ìµëª…'}</h4>
                    <span class="review-date">${formattedDate}</span>
                </div>
            </div>
            <div class="review-rating">
                ${'<span class="star">â˜…</span>'.repeat(review.rating)}
                ${'<span class="star empty">â˜…</span>'.repeat(5 - review.rating)}
            </div>
        </div>
        <div class="review-content">
            <br>${review.content}
        </div>
        <div class="review-helpful">
            <button class="helpful-btn ${review.isLiked ? 'active' : ''}" onclick="toggleHelpful(this, true)">
                ğŸ‘ ë„ì›€ë¨ <span>${review.helpful || 0}</span>
            </button>
        </div>
        ${review.isAuthor ? `
            <div class="review-actions">
                <button class="edit-btn" onclick="editReview(${review.id})">âœï¸ ìˆ˜ì •</button>
                <button class="delete-btn" onclick="deleteReview(${review.id})">ğŸ—‘ ì‚­ì œ</button>
            </div>
        ` : ''}
    `;

                return reviewDiv;
            }

            // Utility functions
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            function scrollMedia(containerId, direction) {
                const container = document.getElementById(containerId);
                const scrollAmount = 320;
                container.scrollBy({
                    left: direction * scrollAmount,
                    behavior: 'smooth'
                });
            }

            function scrollPremium(containerId, direction) {
                const container = document.getElementById(containerId);
                const scrollAmount = 450;
                container.scrollBy({
                    left: direction * scrollAmount,
                    behavior: 'smooth'
                });
            }

            // Rating system functions
            function initializeRatingSystem() {
                const ratingStars = document.querySelectorAll('.rating-star');

                ratingStars.forEach(star => {
                    star.addEventListener('click', function () {
                        selectedRating = parseInt(this.dataset.rating);
                        updateRatingDisplay();
                    });

                    star.addEventListener('mouseover', function () {
                        const rating = parseInt(this.dataset.rating);
                        highlightStars(rating);
                    });
                });

                document.getElementById('ratingInput').addEventListener('mouseleave', function () {
                    updateRatingDisplay();
                });
            }

            function highlightStars(rating) {
                const stars = document.querySelectorAll('.rating-star');
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            }

            function updateRatingDisplay() {
                highlightStars(selectedRating);
            }

            // Review form functions
            function toggleReviewForm() {
                const form = document.getElementById('reviewForm');
                form.classList.toggle('active');
            }

            function submitReview(event) {
                event.preventDefault();

                const content = document.getElementById('reviewContent').value;

                if (selectedRating === 0) {
                    alert('í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!content.trim()) {
                    alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const newReview = {
                    rating: selectedRating,
                    content: content,
                };

                insertReview(newReview);

                // Reset form
                document.getElementById('reviewContent').value = '';
                selectedRating = 0;
                updateRatingDisplay();
                toggleReviewForm();
            }

            // Review CRUD operations
            async function insertReview(newReview) {
                try {
                    const result = await apiRequest(`/review/${planId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: newReview.content,
                            star: newReview.rating
                        })
                    });

                    if (result) {
                        alert("ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        // Reset to first page to show new review
                        currentPage = 0;
                        await loadReviewsData(planId);
                    }
                } catch (error) {
                    alert(error.message || "ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }

            async function deleteReview(reviewId) {
                if (!confirm("ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    return;
                }

                try {
                    await apiRequest(`/review/${reviewId}`, {
                        method: 'DELETE'
                    });

                    alert("ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");

                    // Update local data
                    reviewsData = reviewsData.filter(review => review.id !== reviewId);

                    // If current page becomes empty and it's not the first page, go to previous page
                    if (reviewsData.length === 0 && currentPage > 0) {
                        currentPage--;
                    }

                    await loadReviewsData(planId);
                } catch (error) {
                    alert(error.message || "ë¦¬ë·° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }

            // Review editing functions
            function editReview(reviewId) {
                if (editingReviewId && editingReviewId !== reviewId) {
                    cancelEdit(editingReviewId);
                }

                const reviewItem = document.querySelector(`[data-review-id="${reviewId}"]`);
                const contentElement = reviewItem.querySelector('.review-content');
                const ratingElement = reviewItem.querySelector('.review-rating');
                const actionsElement = reviewItem.querySelector('.review-actions');

                const currentRating = ratingElement.querySelectorAll('.star:not(.empty)').length;
                const currentContent = contentElement.textContent.trim();

                originalData[reviewId] = {
                    rating: currentRating,
                    content: currentContent
                };

                reviewItem.classList.add('editing');
                editingReviewId = reviewId;

                const editForm = createEditForm(reviewId, currentRating, currentContent);

                contentElement.style.display = 'none';
                actionsElement.style.display = 'none';

                reviewItem.appendChild(editForm);
            }

            function createEditForm(reviewId, currentRating, currentContent) {
                const editDiv = document.createElement('div');
                editDiv.className = 'edit-form';
                editDiv.innerHTML = `
        <div class="edit-form-group">
            <label class="edit-form-label">í‰ì </label>
            <div class="edit-rating-input" data-review-id="${reviewId}">
                ${Array.from({length: 5}, (_, i) =>
                    `<span class="edit-rating-star ${i < currentRating ? 'active' : ''}" data-rating="${i + 1}">â˜…</span>`
                ).join('')}
            </div>
        </div>
        <div class="edit-form-group">
            <label for="editContent${reviewId}" class="edit-form-label">ë‚´ìš©</label>
            <textarea id="editContent${reviewId}" class="edit-form-textarea" required>${currentContent}</textarea>
        </div>
        <div class="edit-form-actions">
            <button type="button" class="btn-cancel-edit" onclick="cancelEdit(${reviewId})">ì·¨ì†Œ</button>
            <button type="button" class="btn-save-edit" onclick="saveEdit(${reviewId})">ì €ì¥</button>
        </div>
    `;

                // Add rating star event listeners
                const ratingStars = editDiv.querySelectorAll('.edit-rating-star');
                ratingStars.forEach(star => {
                    star.addEventListener('click', function() {
                        const rating = parseInt(this.dataset.rating);
                        updateEditRatingDisplay(reviewId, rating);
                    });

                    star.addEventListener('mouseover', function() {
                        const rating = parseInt(this.dataset.rating);
                        highlightEditStars(reviewId, rating);
                    });
                });

                editDiv.addEventListener('mouseleave', function() {
                    const currentRating = getCurrentEditRating(reviewId);
                    updateEditRatingDisplay(reviewId, currentRating);
                });

                return editDiv;
            }

            function updateEditRatingDisplay(reviewId, rating) {
                highlightEditStars(reviewId, rating);
            }

            function highlightEditStars(reviewId, rating) {
                const stars = document.querySelectorAll(`[data-review-id="${reviewId}"] .edit-rating-star`);
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            }

            function getCurrentEditRating(reviewId) {
                const activeStars = document.querySelectorAll(`[data-review-id="${reviewId}"] .edit-rating-star.active`);
                return activeStars.length;
            }

            async function saveEdit(reviewId) {
                const newContent = document.getElementById(`editContent${reviewId}`).value.trim();
                const newRating = getCurrentEditRating(reviewId);

                if (!newContent) {
                    alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (newRating === 0) {
                    alert('í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    await apiRequest(`/review/${reviewId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: newContent, star: newRating })
                    });

                    // Update local data
                    const review = reviewsData.find(r => r.id == reviewId);
                    if (review) {
                        review.content = newContent;
                        review.rating = newRating;
                    }

                    updateReviewDisplay(reviewId, newRating, newContent);
                    exitEditMode(reviewId);

                    alert('ë¦¬ë·°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');

                    // Refresh to ensure data consistency
                    await loadReviewsData(planId);
                } catch (error) {
                    alert(error.message || 'ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            function cancelEdit(reviewId) {
                exitEditMode(reviewId);
            }

            function exitEditMode(reviewId) {
                const reviewItem = document.querySelector(`[data-review-id="${reviewId}"]`);
                const editForm = reviewItem.querySelector('.edit-form');
                const contentElement = reviewItem.querySelector('.review-content');
                const actionsElement = reviewItem.querySelector('.review-actions');

                if (editForm) {
                    editForm.remove();
                }

                contentElement.style.display = '';
                actionsElement.style.display = '';

                reviewItem.classList.remove('editing');

                editingReviewId = null;
                delete originalData[reviewId];
            }

            function updateReviewDisplay(reviewId, newRating, newContent) {
                const reviewItem = document.querySelector(`[data-review-id="${reviewId}"]`);
                const contentElement = reviewItem.querySelector('.review-content');
                const ratingElement = reviewItem.querySelector('.review-rating');

                contentElement.textContent = newContent;

                ratingElement.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = i <= newRating ? 'star' : 'star empty';
                    star.textContent = 'â˜…';
                    ratingElement.appendChild(star);
                }
            }

            // Helpful button functions
            function toggleHelpful(button) {
                const span = button.querySelector('span');
                const currentCount = parseInt(span.textContent);
                const reviewItem = button.closest('.review-item');
                const reviewId = reviewItem.getAttribute('data-review-id');

                const isActive = button.classList.contains('active');
                const newCount = isActive ? currentCount - 1 : currentCount + 1;

                // Update UI immediately
                button.classList.toggle('active', !isActive);
                span.textContent = Math.max(0, newCount);

                // Update local data
                const review = reviewsData.find(r => r.id == reviewId);
                if (review) {
                    review.helpful = Math.max(0, newCount);
                    review.isLiked = !isActive;
                }

                handleLikeClick(reviewId, !isActive);
            }

            async function handleLikeClick(reviewId, isAdd) {
                try {
                    await apiRequest(`/review/like/${reviewId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ isAdd })
                    });
                } catch (error) {
                    console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                    // Revert UI changes on error
                    const reviewItem = document.querySelector(`[data-review-id="${reviewId}"]`);
                    const button = reviewItem.querySelector('.helpful-btn');
                    const span = button.querySelector('span');
                    const currentCount = parseInt(span.textContent);

                    button.classList.toggle('active');
                    span.textContent = isAdd ? currentCount - 1 : currentCount + 1;

                    const review = reviewsData.find(r => r.id == reviewId);
                    if (review) {
                        review.helpful = isAdd ? currentCount - 1 : currentCount + 1;
                        review.isLiked = !isAdd;
                    }
                }
            }

            // ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
            function scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            const scrollTopBtn = document.getElementById('scrollTopBtn');

            window.addEventListener('scroll', function () {
                if (window.scrollY > 800) {
                    scrollTopBtn.style.display = 'flex';
                } else {
                    scrollTopBtn.style.display = 'none';
                }
            });

            scrollTopBtn.addEventListener('click', scrollToTop);
        </script>
    </body>

    </html>