<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5G 스탠다드 - YOAJUNG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/884094d6e6.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="assets/css/plan-detail.css"/>
</head>

    <body>
        <!-- Navigation -->
        <div id="navbar"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="index.html">홈</a> >
                <a href="plans.html">요금제</a> >
                <div id="planDetailName"> 5G 스탠다드 </div>
            </div>

            <div class="plan-header">
                <div class="plan-info">
                    <h1 id="planName">로딩 중...</h1>
                    <div class="plan-badges">
                        <span class="badge badge-popular">인기</span>
                        <span class="badge badge-5g" id="networkType">5G</span>
                        <span class="badge badge-category" id="planCategory">PHONE</span>
                    </div>
                    <div class="plan-price">
                        월 <span id="basePrice">0</span>원
                    </div>
                    <p class="plan-description" id="planDescription">
                        로딩 중...
                    </p>

                    <div class="plan-features">
                        <div class="feature-item">
                            <div class="feature-icon">📱</div>
                            <span class="feature-text">데이터 <span id="dataAllowance">0</span></span>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">🔗</div>
                            <span class="feature-text">테더링 <span id="tetheringSharingAllowance">0</span>GB</span>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">🚀</div>
                            <span class="feature-text">속도제한 후 <span id="speedAfterLimit">0</span>Mbps</span>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Benefits Section -->
            <div class="benefits-section">
                <div class="benefit-category" id="baseBenefitsSection">
                    <div class="category-header">
                        <h1 class="category-title">
                            <span class="category-icon">⭐</span>
                            기본 혜택
                        </h1>
                        <p class="category-description">기본으로 제공되는 혜택입니다</p>
                    </div>
                    <div class="benefits-grid" id="baseBenefits"></div>
                </div>
            </div>

            <!-- Media Benefits -->
            <div class="benefits-section" id="mediaContainer">
                <!-- Media Benefits -->
                <div class="benefit-category" id="mediaBenefitsSection">
                    <div class="category-header">
                        <h1 class="category-title">
                            <span class="category-icon">🎵</span>
                            미디어 혜택
                            <span class="choose-one-badge">택 1</span>
                        </h1>
                        <p class="category-description">다양한 미디어 서비스 중 하나를 선택하세요</p>
                    </div>
                    <div class="benefits-container">
                        <button class="scroll-button prev" onclick="scrollBenefits('mediaBenefits', -1)">
                            <i class="fa-solid fa-angle-left" style="color: black"></i>
                        </button>
                        <div class="product-grid" id="mediaBenefits"></div>
                        <button class="scroll-button next" onclick="scrollBenefits('mediaBenefits', 1)">
                            <i class="fa-solid fa-angle-right" style="color: black"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Benefits Section -->
            <div class="benefits-section" id="premiumContainer">
                <!-- Premium Benefits -->
                <div class="benefit-category" id="premiumBenefitsSection">
                    <div class="category-header">
                        <h1 class="category-title">
                            <span class="category-icon">🎁</span>
                            프리미엄 혜택
                            <span class="choose-one-badge">택 1</span>
                        </h1>
                        <p class="category-description">프리미엄 서비스 중 하나를 선택하세요</p>
                    </div>
                    <div class="benefits-container">
                        <button class="scroll-button prev" onclick="scrollBenefits('mediaBenefits', -1)">
                            <i class="fa-solid fa-angle-left" style="color: black"></i>
                        </button>
                        <div class="product-grid" id="premiumBenefits"></div>
                        <button class="scroll-button next" onclick="scrollBenefits('mediaBenefits', 1)">
                            <i class="fa-solid fa-angle-right" style="color: black"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="reviews-section">
                <div class="reviews-header">
                    <h2 class="reviews-title">사용자 리뷰</h2>
                    <div class="reviews-stats">
                        <div class="rating-summary">
                            <span class="rating-score" id="averageRating">0.0</span>
                            <div class="stars" id="averageStars"></div>
                            <span class="review-count" id="reviewCount">(0개 리뷰)</span>
                        </div>
                        <button id="write-review-btn" class="write-review-btn" onclick="toggleReviewForm()"  style="display: none;">
                            리뷰 작성
                        </button>
                    </div>
                </div>

                <!-- Review Form -->
                <div class="review-form" id="reviewForm">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">리뷰 작성</h3>
                    <form onsubmit="submitReview(event)">
                        <div class="form-group">
                            <label class="form-label">평점</label>
                            <div class="rating-input" id="ratingInput">
                                <span class="rating-star" data-rating="1">★</span>
                                <span class="rating-star" data-rating="2">★</span>
                                <span class="rating-star" data-rating="3">★</span>
                                <span class="rating-star" data-rating="4">★</span>
                                <span class="rating-star" data-rating="5">★</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="reviewContent" class="form-label">내용</label>
                            <textarea id="reviewContent" class="form-textarea" placeholder="이 요금제에 대한 경험을 공유해주세요" required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancel" onclick="toggleReviewForm()">취소</button>
                            <button type="submit" class="btn-submit">리뷰 등록</button>
                        </div>
                    </form>
                </div>

                <!-- Reviews List -->
                <div class="reviews-list" id="reviewsList">
                    <!-- Reviews will be loaded here -->
                </div>

                <div class="pagination" id="reviewsPagination" style="text-align: center; margin-top: 20px;"></div>
            </div>
        </main>

        <button class="chat-button" onclick="startRecommendation()" title="AI 추천 받기">💬</button>

        <button id="scrollTopBtn" title="맨 위로"><i class="fa-solid fa-caret-up" style="color: white"></i></button>


        <script>
            // Global variables
            let selectedRating = 0;
            let planData = null;
            let benefitsData = null;
            let productsData = null;
            let reviewsData = [];
            let responseReview = [];
            let planId;

            let currentPage = 0;
            const pageSize = 5;
            let totalPages = 1;

            // Initialize page
            document.addEventListener('DOMContentLoaded', async () => {
                // Load navbar
                try {
                    const response = await fetch('/assets/navbar.html');
                    if (response.ok) {
                        const html = await response.text();
                        document.getElementById('navbar').innerHTML = html;
                    }
                } catch (err) {
                    console.error('navbar 로딩 실패:', err);
                }

                // Get plan ID from URL or use default
                planId = getPlanIdFromUrl() || 1;

                // Load plan data
                await loadPlanData(planId);
                await loadBenefitsData(planId);
                await loadProductsData(planId);
                await loadReviewsData(planId);

                // Initialize rating system
                initializeRatingSystem();
            });

            // Extract plan ID from URL
            function getPlanIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id') || window.location.pathname.split('/').pop();
            }

            // Load plan data from API
            async function loadPlanData(planId) {
                try {
                    const response = await fetch(`/api/plan/${planId}`);
                    const result = await response.json();

                    if (result.status === 'OK' && result.data) {
                        planData = result.data;
                        updatePlanInfo();
                    }
                } catch (error) {
                    console.error('Plan data loading failed:', error);
                    updatePlanInfo();
                }
            }

            // Load benefits data from API
            async function loadBenefitsData(planId) {
                try {
                    const response = await fetch(`/api/plan/benefits/${planId}`);
                    const result = await response.json();

                    if (result.status === 'OK' && result.data) {
                        benefitsData = result.data;
                        updateBenefitsInfo();
                    }
                } catch (error) {
                    console.error('Benefits data loading failed:', error);
                    updateBenefitsInfo();
                }
            }

            // Load products data from API
            async function loadProductsData(planId) {
                try {
                    const response = await fetch(`/api/plan/products/${planId}`);
                    const result = await response.json();

                    if (result.status === 'OK' && result.data) {
                        productsData = result.data;
                        updateProductsInfo();
                    }
                } catch (error) {
                    console.error('Products data loading failed:', error);
                    updateProductsInfo();
                }
            }

            // Load reviews data from API
            async function loadReviewsData(planId) {
                try {
                    const response = await fetch(`/review/${planId}?page=${currentPage}&size=${pageSize}`);
                    const result = await response.json();

                    if (result.status === 'OK' && result.data) {
                        responseReview = result.data;
                        totalPages = result.data.totalPages;

                        const isPlanUser = result.data.isPlanUser;
                        const reviewWriteBtn = document.getElementById('write-review-btn');
                        if (reviewWriteBtn) {
                            reviewWriteBtn.style.display = isPlanUser ? 'inline-block' : 'none';
                        }
                    }
                    updateReviewsInfo();
                } catch (error) {
                    console.error('Reviews data loading failed:', error);
                    updateReviewsInfo();
                }
            }

            // Update plan information
            function updatePlanInfo() {
                if (!planData) return;

                document.getElementById('planName').textContent = planData.name;
                document.getElementById('planDetailName').textContent = planData.name;
                document.getElementById('basePrice').textContent = planData.basePrice.toLocaleString();
                document.getElementById('planDescription').textContent = planData.description;

                // Update network type
                const networkType = planData.networkType === 'FIVE_G' ? '5G' : '4G';
                document.getElementById('networkType').textContent = networkType;

                // Update data allowance
                const dataText = planData.dataAllowance === 9999 ? '무제한' : planData.dataAllowance + 'GB';
                document.getElementById('dataAllowance').textContent = dataText;

                document.getElementById('tetheringSharingAllowance').textContent = planData.tetheringSharingAllowance;
                document.getElementById('speedAfterLimit').textContent = planData.speedAfterLimit;
            }

            // Update benefits information
            function updateBenefitsInfo() {
                if (!benefitsData) return;

                // baseBenefitsSection에 모든 혜택을 모아 렌더링
                const sectionId = 'baseBenefitsSection';
                const gridId = 'baseBenefits';
                const section = document.getElementById(sectionId);
                const grid = document.getElementById(gridId);

                grid.innerHTML = ''; // 기존 카드 제거

                const categoryTypes = {
                    voice: 'VOICE',
                    sms: 'SMS',
                    smartDevice: 'SMARTDEVICE',
                    base: 'BASE',
                    other: 'OTHER'
                };

                let hasBenefits = false;

                for (const [key, type] of Object.entries(categoryTypes)) {
                    const benefit = benefitsData[key];
                    if (benefit) {
                        const benefitCard = createBenefitCard({
                            id: `${type.toLowerCase()}_benefit`,
                            name: benefit.name,
                            description: benefit.description,
                            type: type,
                            discountAmount: benefit.discountAmount
                        });
                        grid.appendChild(benefitCard);
                        hasBenefits = true;
                    }
                }

                // 혜택 있으면 섹션 표시
                if (hasBenefits) {
                    section.classList.add('has-benefits');
                } else {
                    section.classList.remove('has-benefits');
                }
            }

            function updateProductsInfo() {
                const premiumContainer = document.getElementById('premiumContainer');
                const mediaContainer = document.getElementById('mediaContainer');

                const premiumSection = document.getElementById('premiumBenefitsSection');
                const mediaSection = document.getElementById('mediaBenefitsSection');

                const mediaBenefitsGrid = document.getElementById('mediaBenefits');
                const premiumBenefitsGrid = document.getElementById('premiumBenefits');

                // 초기화
                mediaBenefitsGrid.innerHTML = '';
                premiumBenefitsGrid.innerHTML = '';
                mediaSection.classList.remove('has-benefits');
                premiumSection.classList.remove('has-benefits');
                mediaContainer.style.display = 'none';
                premiumContainer.style.display = 'none';

                // Handle media products
                if (productsData.media && productsData.media.length > 0) {
                    mediaContainer.style.display = '';
                    mediaSection.classList.add('has-benefits');

                    productsData.media.forEach((product, index) => {
                        const benefitCard = createProductCard({
                            id: `media_${index}`,
                            name: product.name,
                            description: product.description,
                            type: 'MEDIA',
                            imageUrl: product.productImage
                        });
                        mediaBenefitsGrid.appendChild(benefitCard);
                    });
                }

                // Handle premium products
                if (productsData.premium && productsData.premium.length > 0) {
                    premiumContainer.style.display = '';
                    premiumSection.classList.add('has-benefits');

                    productsData.premium.forEach((product, index) => {
                        const benefitCard = createProductCard({
                            id: `premium_${index}`,
                            name: product.name,
                            description: product.description,
                            type: 'PREMIUM',
                            imageUrl: product.productImage
                        });
                        premiumBenefitsGrid.appendChild(benefitCard);
                    });
                }
            }

            // Create benefit card element
            function createBenefitCard(benefit) {
                const card = document.createElement('div');
                card.className = 'benefit-card';
                card.setAttribute('data-benefit-id', benefit.id);

                let limitText = '';
                if (benefit.discountAmount && benefit.discountAmount > 0) {
                    limitText = `${benefit.discountAmount.toLocaleString()}원 할인`;
                } else {
                    limitText = '제공';
                }

                card.innerHTML = `
                    <div class="benefit-header">
                        <div class="benefit-info">
                            <h4 class="benefit-name">${benefit.name}</h4>
                        </div>
                    </div>
                    <p class="benefit-description">${benefit.description}</p>
                    <div class="benefit-details">
                        <span class="benefit-limit">${limitText}</span>
                    </div>
                `;

                return card;
            }

            function createProductCard(product) {
                const card = document.createElement('div');
                card.className = 'product-card';

                const imageHTML = product.imageUrl
                    ? `<img src="/assets/image/${product.imageUrl}" alt="${product.name}" class="product-image">`
                    : '<img src="/assets/image/defaultImg.jpg" alt="${product.name}" class="product-image">';

                card.innerHTML = `
                    ${imageHTML}
                    <div class="product-name">${product.name}</div>
                    <div class="product-description">${product.description}</div>
                `;

                return card;
            }

            // Scroll benefits function
            function scrollBenefits(containerId, direction) {
                const container = document.getElementById(containerId);
                const scrollAmount = 320; // Card width + gap
                container.scrollBy({
                    left: direction * scrollAmount,
                    behavior: 'smooth'
                });
            }

            // Update reviews information
            function updateReviewsInfo() {

                reviewsData = responseReview.content.map(review => ({
                    id: review.reviewId,
                    userId: review.userId,
                    userName: review.userName,
                    content: review.content,
                    rating: review.star,
                    helpful: review.likeCnt,
                    notHelpful: 0,
                    createdAt: review.createDate,
                    isAuthor: review.author,
                    isLiked: review.liked
                }));

                updateReviewsStats();
                renderReviews();
                renderPagination();
            }

            // Update reviews statistics
            function updateReviewsStats() {
                document.getElementById('averageRating').textContent = responseReview.avgStar.toFixed(1);
                document.getElementById('reviewCount').textContent = `(${responseReview.totalElements}개 리뷰)`;

                // Update average stars
                const starsContainer = document.getElementById('averageStars');
                starsContainer.innerHTML = '';
                const rating = Math.round(parseFloat(responseReview.avgStar));

                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = i <= rating ? 'star' : 'star empty';
                    star.textContent = '★';
                    starsContainer.appendChild(star);
                }
            }

            // Render reviews list
            function renderReviews() {
                const reviewsList = document.getElementById('reviewsList');
                reviewsList.innerHTML = '';

                if (reviewsData.length === 0) {
                    reviewsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px 0;">아직 리뷰가 없습니다. 첫 번째 리뷰를 작성해보세요!</p>';
                    return;
                }

                reviewsData.forEach(review => {
                    const reviewElement = createReviewElement(review);
                    reviewsList.appendChild(reviewElement);
                });
            }

            function renderPagination() {
                const pagination = document.getElementById('reviewsPagination');
                pagination.innerHTML = '';

                if (totalPages <= 1) return;

                for (let i = 0; i < totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i + 1;
                    btn.className = (i === currentPage) ? 'active' : '';
                    btn.addEventListener('click', () => {
                        if (i !== currentPage) {
                            currentPage = i;
                            loadReviewsData(planId);  // ← planId 유지 필요
                        }
                    });
                    pagination.appendChild(btn);
                }
            }

            // Create review element
            function createReviewElement(review) {
                const reviewDiv = document.createElement('div');
                reviewDiv.className = 'review-item';
                reviewDiv.setAttribute('data-review-id', review.id);

                const avatar = review.userName ? review.userName.charAt(0) : '?';
                const formattedDate = formatDate(review.createdAt);

                reviewDiv.innerHTML = `
                <div class="review-header">
                    <div class="reviewer-info">
                        <div class="reviewer-avatar">${avatar}</div>
                        <div class="reviewer-details">
                            <h4>${review.userName || '익명'}</h4>
                            <span class="review-date">${formattedDate}</span>
                        </div>
                    </div>
                    <div class="review-rating">
                        ${'<span class="star">★</span>'.repeat(review.rating)}
                        ${'<span class="star empty">★</span>'.repeat(5 - review.rating)}
                    </div>
                </div>
                <div class="review-content">
                    <br>${review.content}
                </div>
                <div class="review-helpful">
                    <button class="helpful-btn ${review.isLiked ? 'active' : ''}" onclick="toggleHelpful(this, true)">
                        👍 도움됨 <span>${review.helpful || 0}</span>
                    </button>
                </div>

            ${review.isAuthor ? `
                <div class="review-actions">
                    <button class="edit-btn" onclick="editReview(${review.id})">✏️ 수정</button>
                    <button class="delete-btn" onclick="deleteReview(${review.id})">🗑 삭제</button>
                </div>
            ` : ''}

            `;

                return reviewDiv;
            }

            // Format date
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // Initialize rating system
            function initializeRatingSystem() {
                const ratingStars = document.querySelectorAll('.rating-star');

                ratingStars.forEach(star => {
                    star.addEventListener('click', function () {
                        selectedRating = parseInt(this.dataset.rating);
                        updateRatingDisplay();
                    });

                    star.addEventListener('mouseover', function () {
                        const rating = parseInt(this.dataset.rating);
                        highlightStars(rating);
                    });
                });

                document.getElementById('ratingInput').addEventListener('mouseleave', function () {
                    updateRatingDisplay();
                });
            }

            // Highlight stars
            function highlightStars(rating) {
                const stars = document.querySelectorAll('.rating-star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }

            // Update rating display
            function updateRatingDisplay() {
                highlightStars(selectedRating);
            }

            // Toggle review form
            function toggleReviewForm() {
                const form = document.getElementById('reviewForm');
                form.classList.toggle('active');
            }

            // Submit review
            function submitReview(event) {
                event.preventDefault();

                const content = document.getElementById('reviewContent').value;

                if (selectedRating === 0) {
                    alert('평점을 선택해주세요.');
                    return;
                }

                if (!content.trim()) {
                    alert('리뷰 내용을 입력해주세요.');
                    return;
                }

                // Create new review object
                const newReview = {
                    rating: selectedRating,
                    content: content,
                };

                insertReview(newReview);

                // Reset form
                document.getElementById('reviewContent').value = '';
                selectedRating = 0;
                updateRatingDisplay();
                toggleReviewForm();
            }

            function toggleHelpful(button) {
                const span = button.querySelector('span');
                const currentCount = parseInt(span.textContent);
                const reviewItem = button.closest('.review-item');
                const reviewId = reviewItem.getAttribute('data-review-id');

                const isActive = button.classList.contains('active');

                if (isActive) {
                    // 비활성화
                    button.classList.remove('active');
                    span.textContent = currentCount - 1;

                    // 로컬 데이터 업데이트
                    const review = reviewsData.find(r => r.id == reviewId);
                    if (review) {
                        review.helpful = Math.max(0, review.helpful - 1);
                    }

                    handleLikeClick(reviewId, false); // false = 제거
                } else {
                    // 활성화
                    button.classList.add('active');
                    span.textContent = currentCount + 1;

                    // 로컬 데이터 업데이트
                    const review = reviewsData.find(r => r.id == reviewId);
                    if (review) {
                        review.helpful = (review.helpful || 0) + 1;
                    }

                    handleLikeClick(reviewId, true); // true = 추가
                }
            }

            function handleLikeClick(reviewId, isAdd) {
                fetch(`/review/like/${reviewId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isAdd }) // 상태 정보 포함
                })
                    .then(response => {
                        if (response.status === 401) {
                            alert("로그인이 필요합니다.");
                            window.location.href = "/login";
                            return;
                        }
                        if (!response.ok) throw new Error('도움 투표 실패');
                    })
                    .catch(error => {
                        console.error('도움됨 처리 실패:', error);
                    });
            }

            async function insertReview(newReview) {
                try {
                    const response = await fetch(`/review/${planId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: newReview.content,
                            star: newReview.rating
                        })
                    });

                    if (response.status === 401) {
                        alert("로그인이 필요합니다.");
                        window.location.href = "/login";
                        return;
                    }

                    if (!response.ok) {
                        const result = await response.json().catch(() => ({}));
                        alert(result.message || "리뷰 등록 실패");
                        return;
                    }

                    alert("리뷰가 등록되었습니다.");

                    await loadReviewsData(planId); // 등록 후 목록 갱신

                } catch (error) {
                    console.error("리뷰 등록 중 오류:", error);
                    alert("리뷰 등록에 실패했습니다.");
                }
            }

            // 맨 위로 스크롤
            function scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            const scrollTopBtn = document.getElementById('scrollTopBtn');

            window.addEventListener('scroll', function () {
                if (window.scrollY > 800) {
                    scrollTopBtn.style.display = 'flex';
                } else {
                    scrollTopBtn.style.display = 'none';
                }
            });

            scrollTopBtn.addEventListener('click', scrollToTop);
        </script>
    </body>

    </html>