<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>요금제 리스트 - YOAJUNG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/884094d6e6.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="assets/css/plan-list.css"/>
</head>

<body>
    <!-- Navigation -->
    <div id="navbar"></div>

    <div class="main-content">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-container">
                <h1 class="filter-title">요금제</h1>
                <div class="category-menu">
                    <button type="button" class="category-btn active" onclick="filterByCategory('all')">전체</button>
                    <button type="button" class="category-btn" onclick="filterByCategory('LTE_FIVE_G')">5G/LTE</button>
                    <button type="button" class="category-btn" onclick="filterByCategory('ONLINE_ONLY')">온라인 전용</button>
                </div>
            </div>
        </div>

        <!-- Plans Container -->
        <div class="plans-container">
            <div class="plans-header">
                <div class="plans-count" id="plansCount">총 0개의 요금제</div>
                <div class="plans-filter">
                    <select class="sort-select" onchange="sortPlans()">
                        <option value="POPULAR">인기순</option>
                        <option value="LOW_PRICE">가격 낮은순</option>
                        <option value="HIGH_PRICE">가격 높은순</option>
                        <option value="HIGH_DATA">데이터 많은순</option>
                    </select>
                    <select class="sort-select" onchange="">
                        <option value="">전체</option>
                        <option value="">20대</option>
                        <option value="">30대</option>
                        <option value="">40대</option>
                        <option value="">50대</option>
                        <option value="">60대 이상</option>
                    </select>
                    <div class="plan-user-filter">
                        <i class="fa-solid fa-filter"></i>
                        <p>필터</p>
                    </div>
                </div>
            </div>

            <div class="detailed-plans-grid" id="plans-grid">
                <!-- Plans will be populated by API -->
            </div>

            <!-- Load More Button -->
            <div class="load-more-container" id="loadMoreContainer" style="display: none;">
                <button class="load-more-btn" id="loadMoreBtn" type="button">
                    <span class="current-count" id="currentCount">0</span>개 / 총 <span id="totalCount">0</span>개 상품
                </button>
            </div>
        </div>
    </div>

    <button class="chat-button" onclick="startRecommendation()" title="AI 추천 받기">💬</button>

    <button id="scrollTopBtn" title="맨 위로"><i class="fa-solid fa-caret-up" style="color: white"></i></button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/assets/navbar.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('navbar').innerHTML = html;
                })
                .catch(err => console.error('navbar 로딩 실패:', err));
        });

        // State management
        let currentPage = 0;
        let pageSize = 9;
        let currentCategory = '';
        let currentSortType = 'POPULAR';
        let totalPlans = 0;
        let loadedPlans = [];
        let hasMoreData = true;

        // 상태 초기화 함수 추가
        function resetState() {
            currentPage = 0;
            loadedPlans = [];
            hasMoreData = true;
            totalPlans = 0;
        }

        // API call function
        async function fetchPlans(page = 0, size = 9, planType = '', sortedType = 'POPULAR') {
            try {
                const params = new URLSearchParams({
                    page: page.toString(),
                    size: size.toString(),
                    planType: planType,
                    sortedType: sortedType
                });

                const response = await fetch(`api/plan?${params}`);
                const data = await response.json();

                if (data.status === 'OK') {
                    return {
                        plans: data.data.plans,
                        totalCount: data.data.count
                    };
                } else {
                    throw new Error(data.message || '요금제 조회에 실패했습니다.');
                }
            } catch (error) {
                console.error('API 호출 실패:', error);
                showError('요금제 목록을 불러오는데 실패했습니다.');
                return { plans: [], totalCount: 0 };
            }
        }

        // Render plans function (append mode for load more, replace mode for new filter/sort)
        function renderPlans(plans, append = false) {
            const plansGrid = document.getElementById('plans-grid');

            if (!append) {
                plansGrid.innerHTML = '';
            }

            if (plans.length === 0 && !append) {
                plansGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>해당하는 요금제가 없습니다</h3>
                        <p>다른 카테고리를 선택해보세요.</p>
                    </div>
                `;
                return;
            }

            plans.forEach(plan => {
                const planCard = document.createElement('div');
                planCard.className = 'detailed-plan-card';
                planCard.innerHTML = `
                    <div class="plan-header">
                        <h3 class="plan-name">${plan.name}</h3>
                        <span class="network-badge ${plan.networkType.toLowerCase()}">${plan.networkType}</span>
                    </div>
                    <div class="plan-price">월 ${plan.basePrice.toLocaleString()}원</div>
                    <div class="plan-details">
                        <div class="detail-row">
                            <span class="detail-label">데이터</span>
                            <span class="detail-value">${plan.dataAllowance === 9999 ? '무제한' : plan.dataAllowance + 'GB'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">테더링</span>
                            <span class="detail-value">${plan.tetheringSharingAllowance === 9999 ? '무제한' : plan.tetheringSharingAllowance + 'GB'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">속도제한 후</span>
                            <span class="detail-value">${plan.speedAfterLimit}Mbps</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">카테고리</span>
                            <span class="detail-value">${getCategoryName(plan.planCategory)}</span>
                        </div>
                    </div>
                    <div class="services-section">
                        <div class="services-title">포함 서비스</div>
                        <div class="services-list">
                            ${plan.products.map(product => `<span class="service-tag">${product.name}</span>`).join('')}
                        </div>
                    </div>
                    <p class="plan-description">${plan.description}</p>
                    <button class="btn btn-primary btn-large" style="width: 100%;" onclick="goToDetail(${plan.planId})">자세히 보기</button>
                `;
                plansGrid.appendChild(planCard);
            });

            // Update loaded plans array
            if (append) {
                loadedPlans = [...loadedPlans, ...plans];
            } else {
                loadedPlans = [...plans];
            }
        }

        // Helper functions
        function getCategoryName(category) {
            const categoryNames = {
                'LTE_FIVE_G': '5G/LTE',
                'ONLINE_ONLY': '온라인전용',
                'TABLET_WATCH': '태블릿/워치',
                'DUAL_NUMBER': '듀얼넘버'
            };
            return categoryNames[category] || category;
        }

        function showError(message) {
            const plansGrid = document.getElementById('plans-grid');
            plansGrid.innerHTML = `
                <div class="error-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                    <h3>오류가 발생했습니다</h3>
                    <p>${message}</p>
                    <button onclick="loadPlans()" class="btn btn-primary">다시 시도</button>
                </div>
            `;
        }

        // Category filter function - 수정됨
        async function filterByCategory(category) {
            // Update active state of buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            currentCategory = category === 'all' ? '' : category;

            // 상태 완전 초기화
            resetState();

            await loadPlans(false); // false = replace mode
        }

        // Sort function - 수정됨
        async function sortPlans() {
            const sortSelect = document.querySelector('.sort-select');
            currentSortType = sortSelect.value;

            // 상태 완전 초기화
            resetState();

            await loadPlans(false); // false = replace mode
        }

        // Load more function
        async function loadMorePlans() {
            if (!hasMoreData) return;

            currentPage++;
            await loadPlans(true); // append mode
        }

        // Update load more button - 수정됨
        function updateLoadMoreButton(currentCount, totalCount) {
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const currentCountEl = document.getElementById('currentCount');
            const totalCountEl = document.getElementById('totalCount');
            const plansCountEl = document.getElementById('plansCount');

            // 전체 요금제 수 업데이트
            if (plansCountEl) {
                plansCountEl.textContent = `총 ${totalCount}개의 요금제`;
            }

            // 더보기 버튼 표시/숨김 및 내용 업데이트
            if (currentCount > 0 && totalCount > 0) {
                loadMoreContainer.style.display = 'block';

                if (currentCountEl) {
                    currentCountEl.textContent = currentCount;
                }

                if (totalCountEl) {
                    totalCountEl.textContent = totalCount;
                }

                // 더 로드할 데이터가 있는지 확인
                if (loadMoreBtn) {
                    if (!hasMoreData || currentCount >= totalCount) {
                        loadMoreBtn.disabled = true;
                        loadMoreBtn.innerHTML = `${currentCount}개 / 총 ${totalCount}개 상품 (전체 로드 완료)`;
                    } else {
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.innerHTML = `<span class="current-count">${currentCount}</span>개 / 총 <span>${totalCount}</span>개 상품`;
                    }
                }
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        // Main load function - 수정됨
        async function loadPlans(append = false) {
            const { plans, totalCount } = await fetchPlans(currentPage, pageSize, currentCategory, currentSortType);

            // totalPlans 업데이트
            totalPlans = totalCount;

            // Check if we have more data
            hasMoreData = plans.length === pageSize;

            renderPlans(plans, append);

            // 현재 로드된 플랜 수와 전체 수로 버튼 업데이트
            updateLoadMoreButton(loadedPlans.length, totalPlans);
        }

        function goToDetail(planId) {
            // Navigate to plan detail page
            window.location.href = `/plan-detail.html?id=${planId}`;
        }

        // 맨 위로 스크롤
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const scrollTopBtn = document.getElementById('scrollTopBtn');

        window.addEventListener('scroll', function () {
            if (window.scrollY > 300) {
                scrollTopBtn.style.display = 'flex';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        });

        scrollTopBtn.addEventListener('click', scrollToTop);

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadPlans(false); // false = replace mode for initial load

            const loadMoreBtn = document.getElementById('loadMoreBtn');

            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    loadMorePlans();
                });
            }
        });
    </script>
</body>

</html>