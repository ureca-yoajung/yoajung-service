<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>추가 정보 입력 - YOAJUNG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/signup.css"/>
</head>
<body>
<!-- Navigation -->
<div id="navbar"></div>
<main class="main-content">
    <div class="signup-container">
        <div class="signup-header">
            <h1 class="signup-title">추가 정보 입력</h1>
            <p class="signup-subtitle">마지막 정보를 입력하면 가입이 완료됩니다</p>
        </div>
        <form id="info-form">
            <div class="form-group">
                <label for="email" class="form-label">이메일</label>
                <input type="email" name="email" id="email" class="form-input" readonly placeholder="이메일">
            </div>
            <div class="form-group">
                <label for="name" class="form-label">이름</label>
                <input type="text" name="name" id="name" class="form-input" readonly placeholder="이름">
            </div>
            <input type="hidden" name="password" value="SOCIAL">

            <div class="form-group">
                <label for="phoneNumber" class="form-label">전화번호</label>
                <input type="text" name="phoneNumber" id="phoneNumber" class="form-input"
                       placeholder="전화번호(01012345678)" required>
            </div>
            <div class="form-group">
                <label for="gender" class="form-label">성별</label>
                <select name="gender" id="gender" class="form-input" required>
                    <option value="">성별</option>
                    <option value="MALE">남자</option>
                    <option value="FEMALE">여자</option>
                </select>
            </div>
            <div class="form-group">
                <label for="ageGroup" class="form-label">연령</label>
                <select name="ageGroup" id="ageGroup" class="form-input" required>
                    <option value="">연령</option>
                    <option value="TEN_S">10대</option>
                    <option value="TWENTY_S">20대</option>
                    <option value="THIRTY_S">30대</option>
                    <option value="FORTY_S">40대</option>
                    <option value="FIFTY_S">50대</option>
                    <option value="SIXTY_S_PLUS">60대 이상</option>
                </select>
            </div>
            <div class="form-group">
                <label for="familyCount" class="form-label">가족수</label>
                <input type="number" name="familyCount" id="familyCount" class="form-input" placeholder="가족수" required>
            </div>
            <button type="submit" class="signup-button">가입 완료</button>
        </form>
        <div id="result"></div>
    </div>
</main>
<script>
    // 네비게이션 동적 로딩
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch('/api/user/me', {credentials: 'include'});
            if (res.ok) {
                // 이미 로그인 → 메인 or 마이페이지로
                location.href = "main.html"; // 또는 "mypage.html"
                return;
            }
        } catch (e) {
            // 네트워크 에러 등은 무시
        }

        // 2. 로그인 상태가 아니면 navbar를 불러옴
        fetch('/assets/navbar.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('navbar').innerHTML = html;
                renderNavButtons && renderNavButtons();
            })
            .catch(err => console.error('navbar 로딩 실패:', err));
    });

    async function renderNavButtons() {
        const navBtns = document.getElementById('nav-auth-buttons');
        if (!navBtns) return;
        try {
            const res = await fetch('/api/user/me', {credentials: 'include'});
            if (res.ok) {
                // 로그인 상태
                navBtns.innerHTML = `
                <a href="mypage.html" class="btn btn-ghost">마이페이지</a>
                <button id="logout-btn" class="btn btn-primary">로그아웃</button>
            `;
                document.getElementById('logout-btn').onclick = async function () {
                    await fetch('/api/auth/logout', {method: 'POST', credentials: 'include'});
                    location.href = "login.html";
                };
            } else {
                // 비로그인 상태
                navBtns.innerHTML = `
                <a href="login.html" class="btn btn-ghost">로그인</a>
                <a href="signup.html" class="btn btn-primary">시작하기</a>
            `;
            }
        } catch {
            navBtns.innerHTML = `
            <a href="login.html" class="btn btn-ghost">로그인</a>
            <a href="signup.html" class="btn btn-primary">시작하기</a>
        `;
        }
    }

    // URL에서 email, name 추출해서 readonly input에 자동 세팅
    const params = new URLSearchParams(location.search);
    if (params.get('email')) document.getElementById('email').value = params.get('email');
    if (params.get('name')) document.getElementById('name').value = params.get('name');

    document.getElementById('info-form').onsubmit = async function (e) {
        e.preventDefault();
        const form = e.target;
        const obj = Object.fromEntries(new FormData(form));
        const res = await fetch('/api/oauth/kakao/signup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(obj),
            credentials: 'include'
        });
        const data = await res.json();
        if (res.ok) location.href = "main.html";
        else document.getElementById('result').innerText = data.message || "가입 실패";
    }
</script>
</body>
</html>