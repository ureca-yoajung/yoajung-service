<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶”ê°€ ì •ë³´ ì…ë ¥ - YOAJUNG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/signup.css"/>
</head>
<body>
<!-- Navigation -->
<div id="navbar"></div>
<main class="main-content">
    <div class="signup-container">
        <div class="signup-header">
            <h1 class="signup-title">ì¶”ê°€ ì •ë³´ ì…ë ¥</h1>
            <p class="signup-subtitle">ë§ˆì§€ë§‰ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ê°€ì…ì´ ì™„ë£Œë©ë‹ˆë‹¤</p>
        </div>
        <form id="info-form">
            <div class="form-group">
                <label for="email" class="form-label">ì´ë©”ì¼</label>
                <input type="email" name="email" id="email" class="form-input" readonly placeholder="ì´ë©”ì¼">
            </div>
            <div class="form-group">
                <label for="name" class="form-label">ì´ë¦„</label>
                <input type="text" name="name" id="name" class="form-input" readonly placeholder="ì´ë¦„">
            </div>
            <input type="hidden" name="password" value="SOCIAL">

            <div class="form-group">
                <label for="phoneNumber" class="form-label">ì „í™”ë²ˆí˜¸</label>
                <input type="text" name="phoneNumber" id="phoneNumber" class="form-input"
                       placeholder="ì „í™”ë²ˆí˜¸(01012345678)" required>
            </div>
            <div class="form-group" style="position: relative;">
                <label for="plan-search" class="form-label">ìš”ê¸ˆì œ</label>
                <input type="text" id="plan-search" class="form-input" placeholder="ìš”ê¸ˆì œ ê²€ìƒ‰ (ì„ íƒ ì•ˆ í•˜ë©´ ìš”ê¸ˆì œ ì—†ìŒ)"
                       autocomplete="off">
                <input type="hidden" id="planId" name="planId" value="">
                <div id="plan-list" class="dropdown-list"
                     style="display: none; position: absolute; width: 100%; z-index: 10; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 180px; overflow-y: auto;"></div>
            </div>
            <div class="form-row-horizontal">
                <div class="form-group">
                    <label for="gender" class="form-label">ì„±ë³„</label>
                    <select id="gender" name="gender" class="form-input" required>
                        <option value="">ì„±ë³„</option>
                        <option value="MALE">ë‚¨ì</option>
                        <option value="FEMALE">ì—¬ì</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ageGroup" class="form-label">ì—°ë ¹</label>
                    <select id="ageGroup" name="ageGroup" class="form-input" required>
                        <option value="">ì—°ë ¹</option>
                        <option value="TEN_S">10ëŒ€</option>
                        <option value="TWENTY_S">20ëŒ€</option>
                        <option value="THIRTY_S">30ëŒ€</option>
                        <option value="FORTY_S">40ëŒ€</option>
                        <option value="FIFTY_S">50ëŒ€</option>
                        <option value="SIXTY_S_PLUS">60ëŒ€ ì´ìƒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="familyCount" class="form-label">ê°€ì¡±ìˆ˜</label>
                    <input type="number" id="familyCount" name="familyCount" class="form-input" placeholder="ê°€ì¡±ìˆ˜"
                           required>
                </div>
            </div>
            <div id="signup-result" class="error-message" style="display:none"></div>
            <button type="submit" class="signup-button">ê°€ì… ì™„ë£Œ</button>
        </form>
        <div id="result"></div>
    </div>
</main>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        // ë¡œê·¸ì¸ ìƒíƒœë©´ íšŒì›ê°€ì… ë¶ˆê°€ - ë©”ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        try {
            const res = await fetch('/api/user/me', {credentials: 'include'});
            if (res.ok) {
                location.href = "index.html";
                return;
            }
        } catch (e) {
            // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë“±ì€ ë¬´ì‹œ
        }

        //  ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ navbar ë¶ˆëŸ¬ì™€ì„œ ë Œë”ë§
        try {
            const res = await fetch('/assets/navbar.html');
            const html = await res.text();
            document.getElementById('navbar').innerHTML = html;

            // í•­ìƒ ë¡œê·¸ì¸/ì‹œì‘í•˜ê¸° ë²„íŠ¼ë§Œ ë…¸ì¶œ
            const navBtns = document.getElementById('nav-auth-buttons');
            if (navBtns) {
                navBtns.innerHTML = `
                <a href="login.html" class="btn btn-ghost">ë¡œê·¸ì¸</a>
                <a href="signup.html" class="btn btn-primary">ì‹œì‘í•˜ê¸°</a>
            `;
            }
        } catch (err) {
            console.error('navbar ë¡œë”© ì‹¤íŒ¨:', err);
        }
        // URLì—ì„œ email, name ì¶”ì¶œí•´ì„œ readonly inputì— ìë™ ì„¸íŒ…
        const params = new URLSearchParams(location.search);
        if (params.get('email')) document.getElementById('email').value = params.get('email');
        if (params.get('name')) document.getElementById('name').value = params.get('name');
    });

    // ì¶”ê°€: ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì— accessTokenì´ ì—†ìœ¼ë©´ ì§„ì… ë¶ˆê°€ ì²˜ë¦¬
    if (!sessionStorage.getItem('kakaoAccessToken')) {
        alert("ì¹´ì¹´ì˜¤ ì¸ì¦ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        window.location.href = "login.html";
    }

    document.getElementById('info-form').onsubmit = async function (e) {
        e.preventDefault();
        const form = e.target;
        const obj = Object.fromEntries(new FormData(form));

        // ğŸ”¥ accessTokenì„ ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì™€ í•¨ê»˜ ì „ë‹¬
        const kakaoAccessToken = sessionStorage.getItem('kakaoAccessToken');
        if (!kakaoAccessToken) {
            alert("ì¹´ì¹´ì˜¤ ì¸ì¦ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            window.location.href = "login.html";
            return;
        }
        obj.accessToken = kakaoAccessToken;

        const res = await fetch('/api/oauth/kakao/signup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(obj),
            credentials: 'include'
        });
        const data = await res.json();
        if (res.ok) {
            // ê°€ì… ì™„ë£Œ í›„ í† í° ì œê±°!
            sessionStorage.removeItem('kakaoAccessToken');
            location.href = "index.html";
        } else {
            document.getElementById('result').innerText = data.message || "ê°€ì… ì‹¤íŒ¨";
        }
    }
    // ìš”ê¸ˆì œ ê²€ìƒ‰ ìë™ì™„ì„±
    const planSearch = document.getElementById('plan-search');
    const planList = document.getElementById('plan-list');
    const planIdInput = document.getElementById('planId');

    // ê²€ìƒ‰ ì…ë ¥ì‹œ API ìš”ì²­ ë° ë“œë¡­ë‹¤ìš´
    planSearch.addEventListener('input', async function () {
        const keyword = this.value.trim();
        if (!keyword) {
            planList.style.display = 'none';
            planIdInput.value = ""; // ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ ìš”ê¸ˆì œ ì—†ìŒ
            return;
        }
        try {
            const res = await fetch(`/api/plan/names?keyword=${encodeURIComponent(keyword)}`, {credentials: 'include'});
            const {data} = await res.json();
            planList.innerHTML = '';
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(plan => {
                    const div = document.createElement('div');
                    div.textContent = plan.name;
                    div.style.cursor = "pointer";
                    div.onclick = () => {
                        planSearch.value = plan.name;
                        planIdInput.value = plan.planId;
                        planList.style.display = 'none';
                    };
                    planList.appendChild(div);
                });
                planList.style.display = 'block';
            } else {
                planList.innerHTML = '<div>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
                planList.style.display = 'block';
            }
        } catch (e) {
            planList.innerHTML = '<div>ìš”ê¸ˆì œ ë¡œë”© ì‹¤íŒ¨</div>';
            planList.style.display = 'block';
        }
    });

    // ì…ë ¥ì°½ ë°– í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    planSearch.addEventListener('blur', function () {
        setTimeout(() => {
            planList.style.display = 'none';
        }, 200);
    });

    // ì¸í’‹ ê°’ ì§€ì›Œì§€ë©´ ìš”ê¸ˆì œ ì—†ìŒ ì²˜ë¦¬
    planSearch.addEventListener('change', function () {
        if (!this.value) {
            planIdInput.value = "";
        }
    });
</script>
</body>
</html>