<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지 - YOAJUNG</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/mypage.css">
</head>
<body>
<div id="navbar"></div>
<main class="main-content">
    <div class="mypage-container">
        <!-- 프로필 헤더 -->
        <div class="profile-header">
            <div class="profile-name" id="profile-name">이름</div>
            <div class="profile-email" id="profile-email">이메일</div>
        </div>
        <!-- 탭 -->
        <div class="tab-row">
            <button class="tab active" id="tab-info">내 정보</button>
            <button class="tab" id="tab-tendency">내 성향</button>
        </div>
        <!-- 내 정보 -->
        <div class="section active" id="section-info">
            <div class="info-list" id="userinfo"></div>
        </div>
        <!-- 내 성향 -->
        <div class="section" id="section-tendency">
            <div class="tendency-list" id="tendency"></div>
        </div>
    </div>
</main>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- 상태 변수 (중복 선언 X) ---
        let userData = null, userEditMode = false;
        let tendencyData = null, tendencyEditMode = false;

        // 1. 로그인 상태 체크
        const res = await fetch('/api/user/me', {credentials: 'include'});
        if (!res.ok) {
            location.href = "login.html";
            return;
        }
        const userResult = await res.json();
        if (userResult && userResult.data) {
            userData = userResult.data;
            userEditMode = false;
            renderUserInfo();
        }

        // 2. 네비게이션 바 로딩
        try {
            const res = await fetch('/assets/navbar.html');
            const html = await res.text();
            document.getElementById('navbar').innerHTML = html;

            const navBtns = document.getElementById('nav-auth-buttons');
            if (navBtns) {
                navBtns.innerHTML = `
                <a href="index.html" class="btn btn-ghost">메인페이지</a>
                <button id="logout-btn" class="btn btn-primary">로그아웃</button>
            `;
                document.getElementById('logout-btn').onclick = async function () {
                    await fetch('/api/auth/logout', {method: 'POST', credentials: 'include'});
                    location.href = "login.html";
                };
            }
        } catch (err) {
            console.error('navbar 로딩 실패:', err);
        }

        // 3. 탭 이벤트 등록
        const tabInfo = document.getElementById('tab-info');
        const tabTendency = document.getElementById('tab-tendency');
        if (tabInfo && tabTendency) {
            tabInfo.onclick = () => setTab('info');
            tabTendency.onclick = () => setTab('tendency');
        }

        // 4. 내 정보/성향 함수
        function renderUserInfo() {
            const d = userData;
            const el = document.getElementById('userinfo');
            document.getElementById('profile-name').textContent = d?.name || "";
            document.getElementById('profile-email').textContent = d?.email || "";
            if (!d) {
                el.innerHTML = "정보 없음";
                return;
            }
            if (userEditMode) {
                el.innerHTML = `
                <form id="user-edit-form">
                    <div><span class="label">이메일</span><input type="email" name="email" value="${d.email}" disabled></div>
                    <div><span class="label">이름</span><input type="text" name="name" value="${d.name}" disabled></div>
                    <div><span class="label">전화번호</span><input type="text" name="phoneNumber" value="${d.phoneNumber || ''}" required></div>
                    <div><span class="label">성별</span>
                        <select name="gender" required>
                            <option value="MALE" ${d.gender === 'MALE' ? 'selected' : ''}>남자</option>
                            <option value="FEMALE" ${d.gender === 'FEMALE' ? 'selected' : ''}>여자</option>
                        </select>
                    </div>
                    <div><span class="label">연령대</span>
                        <select name="ageGroup" required>
                            <option value="TEN_S" ${d.ageGroup === 'TEN_S' ? 'selected' : ''}>10대</option>
                            <option value="TWENTY_S" ${d.ageGroup === 'TWENTY_S' ? 'selected' : ''}>20대</option>
                            <option value="THIRTY_S" ${d.ageGroup === 'THIRTY_S' ? 'selected' : ''}>30대</option>
                            <option value="FORTY_S" ${d.ageGroup === 'FORTY_S' ? 'selected' : ''}>40대</option>
                            <option value="FIFTY_S" ${d.ageGroup === 'FIFTY_S' ? 'selected' : ''}>50대</option>
                            <option value="SIXTY_S_PLUS" ${d.ageGroup === 'SIXTY_S_PLUS' ? 'selected' : ''}>60대 이상</option>
                        </select>
                    </div>
                    <div><span class="label">가족수</span><input type="number" name="familyCount" value="${d.familyCount || ''}" required></div>
                    <button class="save-btn" type="submit">수정 완료</button>
                </form>
            `;
                document.getElementById('user-edit-form').onsubmit = function (e) {
                    e.preventDefault();
                    const obj = Object.fromEntries(new FormData(e.target));
                    fetch('/api/user/me', {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify(obj)
                    }).then(r => r.json()).then(data => {
                        if (data && data.data) {
                            userData = data.data;
                            userEditMode = false;
                            renderUserInfo();
                            alert(data.message || "수정 완료");
                        } else alert(data.message || "실패");
                    });
                }
            } else {
                el.innerHTML = `
                <div><span class="label">이메일</span> <b>${d.email}</b></div>
                <div><span class="label">이름</span> ${d.name}</div>
                <div><span class="label">전화번호</span> ${d.phoneNumber || ''}</div>
                <div><span class="label">성별</span> ${d.gender === 'MALE' ? '남자' : d.gender === 'FEMALE' ? '여자' : ''}</div>
                <div><span class="label">연령대</span> ${
                    d.ageGroup === 'TEN_S' ? '10대'
                        : d.ageGroup === 'TWENTY_S' ? '20대'
                            : d.ageGroup === 'THIRTY_S' ? '30대'
                                : d.ageGroup === 'FORTY_S' ? '40대'
                                    : d.ageGroup === 'FIFTY_S' ? '50대'
                                        : d.ageGroup === 'SIXTY_S_PLUS' ? '60대 이상' : ''
                }</div>
                <div><span class="label">가족수</span> ${d.familyCount || ''}</div>
                <button class="edit-btn" id="user-edit-btn">내 정보 수정</button>
            `;
                document.getElementById('user-edit-btn').onclick = () => {
                    userEditMode = true;
                    renderUserInfo();
                }
            }
        }

        function renderTendency() {
            const d = tendencyData;
            const el = document.getElementById('tendency');
            if (!d && !tendencyEditMode) {
                el.innerHTML = `<div>성향 정보가 없습니다.</div><button class="edit-btn" id="tendency-reg-btn">성향 등록</button>`;
                document.getElementById('tendency-reg-btn').onclick = () => {
                    tendencyEditMode = true;
                    renderTendency();
                }
                return;
            }
            if (tendencyEditMode) {
                el.innerHTML = `
                <form id="tendency-edit-form">
                    <div><span class="label">월평균 데이터 사용량(GB)</span><input name="avgMonthlyDataGB" type="number" value="${d ? d.avgMonthlyDataGB : ''}" required></div>
                    <div><span class="label">월평균 통화량(분)</span><input name="avgMonthlyVoiceMin" type="number" value="${d ? d.avgMonthlyVoiceMin : ''}" required></div>
                    <div><span class="label">희망 요금제 가격(원)</span><input name="preferencePrice" type="number" value="${d ? d.preferencePrice : ''}" required></div>
                    <div><span class="label">기타</span><input name="comment" value="${d ? d.comment : ''}" required></div>
                    <button class="save-btn" type="submit">${d ? '수정 완료' : '등록 완료'}</button>
                </form>
            `;
                document.getElementById('tendency-edit-form').onsubmit = function (e) {
                    e.preventDefault();
                    const obj = Object.fromEntries(new FormData(e.target));
                    fetch('/api/tendency', {
                        method: d ? 'PUT' : 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify(obj)
                    }).then(r => r.json()).then(data => {
                        if (data && data.data) {
                            tendencyData = data.data;
                            tendencyEditMode = false;
                            renderTendency();
                            alert(data.message || "저장 완료");
                        } else alert(data.message || "실패");
                    });
                }
            } else if (d) {
                el.innerHTML = `
                <div><span class="label">월평균 데이터 사용량(GB)</span> ${d.avgMonthlyDataGB} GB</div>
                <div><span class="label">월평균 통화량(분)</span> ${d.avgMonthlyVoiceMin} 분</div>
                <div><span class="label">희망 요금제 가격(원)</span> ${d.preferencePrice} 원</div>
                <div><span class="label">기타</span> ${d.comment}</div>
                <button class="edit-btn" id="tendency-edit-btn">성향 수정</button>
            `;
                document.getElementById('tendency-edit-btn').onclick = () => {
                    tendencyEditMode = true;
                    renderTendency();
                }
            }
        }

        // 탭 전환 함수
        function setTab(tab) {
            document.getElementById('tab-info').classList.toggle('active', tab === 'info');
            document.getElementById('tab-tendency').classList.toggle('active', tab === 'tendency');
            document.getElementById('section-info').classList.toggle('active', tab === 'info');
            document.getElementById('section-tendency').classList.toggle('active', tab === 'tendency');
            if (tab === 'info') loadMyInfo();
            if (tab === 'tendency') loadTendency();
        }

        // 데이터 로드 함수
        async function loadMyInfo() {
            const res = await fetch('/api/user/me', {method: 'GET', credentials: 'include'});
            if (res.status === 401) {
                alert("로그인 필요");
                location.href = "login.html";
                return;
            }
            const data = await res.json();
            if (data && data.data) {
                userData = data.data;
                userEditMode = false;
                renderUserInfo();
            }
        }

        async function loadTendency() {
            const res = await fetch('/api/tendency', {method: 'GET', credentials: 'include'});
            if (res.status === 401) {
                alert("로그인 필요");
                location.href = "login.html";
                return;
            }
            const data = await res.json();
            if (data && data.data) {
                tendencyData = data.data;
                tendencyEditMode = false;
                renderTendency();
            } else {
                tendencyData = null;
                tendencyEditMode = false;
                renderTendency();
            }
        }

        // 최초 렌더 시 정보/성향 동시에 미리 로딩 (탭 전환시 최신화)
        await loadMyInfo();
        await loadTendency();
    });
</script>
</body>
</html>